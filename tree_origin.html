<template>
    <g></g>
</template>

<script>
  import * as d3 from 'd3'
  import {TimelineMax} from 'gsap'

  export default {
    name: 'CircleElement',
    props: ['unique', 'info', 'center'],
    data: () => ({
      opt: {
        radius: 80,
        angle: 180,
        distance: 300,
        url: '',
        background: '#B4A269',
        textColor: '#ffffff',
        text: 'Default Circle Text',
        fontSize: 19,
        isLocked: false
      }
    }),
    watch: {
      center: {
        handler: function (newData, oldData) {
          this.clear()
          this.setOptions(this.info)
          if (oldData.x === 0 && oldData.y === 0) {
            this.drawElement(true)
          } else {
            this.drawElement(false)
          }
        },
        deep: true
      },
      'info.text': function (newData, oldData) {
        this.clear()
        this.setOptions(this.info)
        if (oldData.x === 0 && oldData.y === 0) {
          this.drawElement(true)
        } else {
          this.drawElement(false)
        }
      }
    },
    computed: {
      delta: function () {
        const angle = (this.option.angle / 180) * Math.PI
        return {
          x: (this.option.distance * Math.cos(angle)) + this.center.x,
          y: (this.option.distance * Math.sin(angle)) + this.center.y
        }
      }
    },
    mounted () {
      this.setOptions(this.info)
      this.drawElement(true)
    },
    methods: {
      setOptions (option) {
        const that = this
        this.option = Object.assign({}, that.opt, option)
      },
      drawElement (isAnimation) {
        const opt = this.option
        const g = d3.select(this.$el)
          .attr('transform', `translate(${this.delta.x}, ${this.delta.y})`)
          .attr('cursor', function () {
            if (opt.isLocked) return 'default'
            else return 'pointer'
          })
          .attr('id', 'g-' + this.unique)
          .on('mouseover', () => { if (!opt.isLocked) this.circleHighlightOn(g) })
          .on('mouseout', () => { if (!opt.isLocked) this.circleHighlightOff(g) })
          .on('click', () => { if (!opt.isLocked) this.$emit('click', opt.url) })

        this.drawPath(g)
        this.drawCircle(g, opt)
        this.drawText(g, opt)
        if (isAnimation) this.animation(this.unique)
      },
      drawCircle (ele, opt) {
        const that = this
        ele.append('circle')
          .attr('class', 'circle')
          .attr('id', 'circle-' + that.unique)
          .attr('r', opt.radius)
          .attr('fill', opt.background)
      },
      drawText (ele, opt) {
        const TWidth = 2 * opt.radius * Math.cos(Math.PI / 6)
        const THeight = 2 * opt.radius * Math.sin(Math.PI / 6)
        ele.append('g')
          .attr('class', 'text')
          .attr('id', 'text-' + this.unique)
          .attr('transform', 'translate(' + [-(TWidth / 2), -(THeight / 2)] + ')')
          .append('foreignObject')
          .attr('width', TWidth)
          .attr('height', THeight)
          .append('xhtml:div')
          .append('xhtml:p')
          .style('font-size', opt.fontSize + 'px')
          .style('color', opt.textColor)
          .html(opt.text)
        ele.append('g')
          .attr('class', 'lock')
          .attr('id', 'lock-' + this.unique)
          .attr('transform', 'translate(' + [-10, (opt.radius - 40)] + ')')
          .style('opacity', 1)
          .append('foreignObject')
          .attr('width', 24)
          .attr('height', 24)
          .append('xhtml:i')
          .attr('class', 'material-icons')
          .style('color', opt.textColor)
          .html(() => {
            if (opt.isLocked && opt.radius < 180) {
              return 'lock'
            }
          })
      },
      drawPath (ele) {
        ele.append('line')
          .attr('class', 'line')
          .attr('id', 'path-' + this.unique)
          .attr('stroke', '#1D252C')
          .attr('stroke-width', '2px')
          .attr('x1', 0)
          .attr('y1', 0)
          .attr('x2', this.center.x - this.delta.x)
          .attr('y2', this.center.y - this.delta.y)
      },
      animation (id) {
        const tl = new TimelineMax()
        tl.delay(0).from('#circle-' + id, 0.5, {drawSVG: 0})
          .from('#circle-' + id, 0.5, {'fill': 'none'})
          .from('#text-' + id, 0.5, {'autoAlpha': 0})
          .from('#path-' + id, 0.5, {drawSVG: 0})

        const lock = new TimelineMax()
        lock.delay(1).from('#lock-' + id, 0.5, {'opacity': 0})
      },
      circleHighlightOn (ele) {
        ele.selectAll('circle')
          .style('filter', 'url(#hoverShadow)')
      },
      circleHighlightOff (ele) {
        ele.selectAll('circle')
          .style('fill', '#B4A269')
          .style('filter', '')
      },
      clear () {
        d3.select(this.$el).selectAll('*').remove()
      }
    }
  }
</script>

<style>
    .text div {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
    }

    .text div p {
        margin: 0 auto;
    }
</style>
